name: CI

on:
    push:
        branches:
            - main
    pull_request:

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
    lint:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v6

            - name: Install uv
              uses: astral-sh/setup-uv@v7
              with:
                  enable-cache: true

            - name: Install project (dev only)
              run: uv sync --locked --dev

            - name: Run linters
              run: |
                  uv run ruff check .
                  uv run basedpyright

    build:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v6

            - name: Install uv
              uses: astral-sh/setup-uv@v7
              with:
                  enable-cache: true

            - name: Build package
              run: uv build

    test:
        runs-on: ubuntu-latest
        needs: [lint, build]
        strategy:
            matrix:
                python-version: ["3.14"]
        permissions:
            id-token: write

        steps:
            - uses: actions/checkout@v6

            - name: Install uv and set Python
              uses: astral-sh/setup-uv@v7
              with:
                  enable-cache: true
                  python-version: ${{ matrix.python-version }}

            - name: Install the project
              run: uv sync --locked --all-extras --dev

            - name: Run tests with coverage
              run: uv run pytest -v --cov=afetch --cov-report=xml

            - name: Upload coverage to Codecov
              uses: codecov/codecov-action@v5
              if: ${{ matrix.python-version == '3.14' && github.ref == 'refs/heads/main' }}
              with:
                  files: ./coverage.xml
                  fail_ci_if_error: false
                  use_oicd: true
